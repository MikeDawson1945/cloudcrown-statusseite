name: Status aktualisieren

on:
  schedule:
    - cron: '*/15 * * * *'  # alle 15 Minuten
  workflow_dispatch:

jobs:
  check-status:
    runs-on: ubuntu-latest
    steps:
      - name: Repository klonen
        uses: actions/checkout@v3

      - name: Status pr√ºfen & uptime-history aktualisieren
        run: |
          echo "üîç Starte Statuspr√ºfung..."

          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          check_url() {
            curl -Is --max-time 5 "$1" | head -n 1 | grep -q "200" && echo "online" || echo "offline"
          }

          website=$(check_url https://cloudcrown.ch)

          # Alte Datei einlesen
          history_file="uptime-history.json"
          if [ -f "$history_file" ]; then
            old_data=$(cat "$history_file")
          else
            old_data="[]"
          fi

          # Neue Zeile anh√§ngen
          new_entry="{\"timestamp\": \"$timestamp\", \"status\": \"$website\"}"
          updated_data=$(jq --argjson new "$new_entry" \
            '[.[], $new] | reverse | .[:96] | reverse' <<< "$old_data")

          echo "$updated_data" > "$history_file"

      - name: √Ñnderungen committen
        run: |
          git config user.name "cloudcrown-bot"
          git config user.email "bot@cloudcrown.ch"
          git add uptime-history.json
          git commit -m "üîÑ Uptime aktualisiert" || echo "Keine √Ñnderungen"
          git push
